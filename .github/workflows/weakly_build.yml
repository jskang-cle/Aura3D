name: Build Nuget Packages

on:
  schedule:
    - cron: '30 4 * * 1'  # 每周一 UTC 4:30 执行（北京时间 12:30）
  workflow_dispatch:      # 手动触发（方便调试）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      # 步骤1：生成基于日期的版本号（核心）
      - name: Generate version number
        id: generate_version
        run: |
          # 生成格式：YYYYMMDD（如 20251124）
          DATE_VERSION=$(date +'%Y%m%d')
          # 定义主版本 + 预发布后缀（可根据需求调整主版本）
          VERSION="1.0.0-weekly.${DATE_VERSION}"
          # 输出版本号（供后续步骤使用）
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      # 步骤2：打包 Aura3D.Core（指定动态版本）
      - name: Pack Aura3D.Core
        run: |
          dotnet pack src/Aura3D.Core \
            -o nugets \
            -c Release \  # 建议加 Release 配置，默认 Debug
            /p:Version=${{ steps.generate_version.outputs.VERSION }}

      # 步骤3：打包 Aura3D.Avalonia（复用版本号）
      - name: Pack Aura3D.Avalonia
        run: |
          dotnet pack src/Aura3D.Avalonia \
            -o nugets \
            -c Release \
            /p:Version=${{ steps.generate_version.outputs.VERSION }}

      # 步骤4：上传到 NuGet
      - name: Upload to Nuget
        run: dotnet nuget push "nugets/*.nupkg" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
